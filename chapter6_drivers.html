
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <title>第六章：打工魂 - 驱动与 VFS · EwokOS Microkernel Booklet</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 4.0.8">
        <meta name="author" content="Misa.Z">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/honkit-plugin-mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="chapter7_hands_on.html" />
    
    
    <link rel="prev" href="chapter5_memory.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="chapter1_intro.html">
            
                <a href="chapter1_intro.html">
            
                    
                    第一章：操作系统的世界
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="chapter2_arch.html">
            
                <a href="chapter2_arch.html">
            
                    
                    第二章：EwokOS - 小内核，大梦想
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="chapter3_proc.html">
            
                <a href="chapter3_proc.html">
            
                    
                    第三章：幕后黑手 - 进程与线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="chapter4_ipc.html">
            
                <a href="chapter4_ipc.html">
            
                    
                    第四章：喂，听得见吗？ - IPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="chapter5_memory.html">
            
                <a href="chapter5_memory.html">
            
                    
                    第五章：包租公 - 内存管理
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7" data-path="chapter6_drivers.html">
            
                <a href="chapter6_drivers.html">
            
                    
                    第六章：打工魂 - 驱动与 VFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="chapter7_hands_on.html">
            
                <a href="chapter7_hands_on.html">
            
                    
                    第七章：把手弄脏 - 编译与运行
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            本书使用 HonKit 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >第六章：打工魂 - 驱动与 VFS</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="第六章：打工魂---驱动与-vfs">第六章：打工魂 - 驱动与 VFS</h1>
<p>从前几章，我们知道了进程如何运行、如何通信、如何分配内存。但这些都是软件世界的规则。现在我们要跨越一个关键的边界——<strong>软件如何控制硬件？</strong></p>
<p>键盘、鼠标、硬盘、显卡……这些设备千差万别，每个都有自己的&quot;语言&quot;（寄存器、端口、协议）。如果每个应用程序都要学会如何直接操作硬件，那将是一场噩梦。这就是<strong>驱动程序（Device Driver）</strong>存在的意义。</p>
<p>而在微内核架构中，驱动有一个革命性的设计：<strong>它们不是内核的一部分，而是普通的用户进程</strong>。</p>
<h2 id="61-驱动：我也是个普通人">6.1 驱动：我也是个普通人</h2>
<p>在宏内核里，驱动是拥有至高无上权力的“御前侍卫”。
在微内核里，驱动只是一个普通的“打工仔”。</p>
<h3 id="驱动就是进程">驱动就是进程</h3>
<p>EwokOS 的驱动程序（比如 <code>timerd</code>, <code>uartd</code>）本质上就是<strong>用户进程</strong>。
它们有自己的 <code>main</code> 函数，有自己的 PID，甚至可以被 <code>kill</code> 掉。</p>
<p>唯一的区别是，它们通过系统调用申请了一些特权：</p>
<ul>
<li><strong>I/O 端口访问权</strong>：允许读写特定的硬件端口。</li>
<li><strong>MMIO 映射权</strong>：允许把硬件的物理内存映射到自己的虚拟空间。</li>
<li><strong>中断处理权</strong>：允许接收硬件发出的中断信号。</li>
</ul>
<h2 id="62-实例分析：timerd-的一天">6.2 实例分析：<code>timerd</code> 的一天</h2>
<p>让我们看看时钟驱动 <code>timerd</code> (<code>system/basic/drivers/timerd/timerd.c</code>) 是怎么工作的。</p>
<ol>
<li><p><strong>上班打卡 (启动)</strong>：</p>
<pre><code class="lang-c">int main(int argc, char** argv) {
    // ... 初始化 ...
    vdevice_t dev;
    strcpy(dev.name, &quot;timer&quot;);
    dev.dev_cntl = timer_dcntl; // 设置“业务受理窗口”

    // 向 VFS 注册：我负责 /dev/timer 这个地盘
    device_run(&amp;dev, &quot;/dev/timer&quot;, FS_TYPE_CHAR, 0666);
    return 0;
}
</code></pre>
</li>
<li><p><strong>等待业务 (循环)</strong>：
<code>device_run</code> 内部是一个无限循环，不断调用 <code>ipc_fetch</code> 等待 VFS 派活。</p>
</li>
<li><p><strong>处理业务 (中断)</strong>：
当硬件产生时钟中断时，内核会通知 <code>timerd</code>。
<code>timerd</code> 醒来，更新系统时间，检查有没有闹钟到期了。</p>
</li>
</ol>
<h2 id="63-vfs：全能前台">6.3 VFS：全能前台</h2>
<p><strong>VFS (Virtual File System)</strong> 是整个系统的“前台接待”。
不管你是要读文件、写串口、还是画图，你都得先找 VFS。</p>
<p>EwokOS 遵循 Unix 的哲学：<strong>一切皆文件</strong>。</p>
<ul>
<li>硬盘文件是文件：<code>/home/test.txt</code></li>
<li>串口是文件：<code>/dev/tty0</code></li>
<li>显卡是文件：<code>/dev/fb0</code></li>
<li>甚至进程信息也是文件：<code>/proc/123</code></li>
</ul>
<h3 id="一次-open-的旅程">一次 <code>open</code> 的旅程</h3>
<p>当你调用 <code>open(&quot;/dev/timer&quot;, ...)</code> 时：</p>
<ol>
<li><strong>用户进程</strong>：呼叫 VFS，“我要打开 <code>/dev/timer</code>”。</li>
<li><strong>VFS</strong>：查通讯录（挂载表），发现 <code>/dev/timer</code> 归 <code>timerd</code> 管。</li>
<li><strong>VFS</strong>：呼叫 <code>timerd</code>，“有人要打开你”。</li>
<li><strong>timerd</strong>：确认没问题，返回“同意”。</li>
<li><strong>VFS</strong>：给用户进程发一张“通行证”（文件描述符 fd），上面写着：“以后找 <code>timerd</code>，直接报这个号”。</li>
</ol>
<h3 id="一次-write-的旅程">一次 <code>write</code> 的旅程</h3>
<p>当你调用 <code>write(fd, &quot;hello&quot;, 5)</code> 时：</p>
<ol>
<li><strong>用户进程</strong>：拿着通行证 (fd) 呼叫 VFS。</li>
<li><strong>VFS</strong>：看一眼通行证，哦，是找 <code>timerd</code> 的。</li>
<li><strong>VFS</strong>：把数据转发给 <code>timerd</code>。</li>
<li><strong>timerd</strong>：收到数据，执行相应的硬件操作。</li>
</ol>
<p>虽然中间隔了个 VFS，看起来有点繁琐，但它统一了接口。用户程序不需要知道对面是硬盘还是串口，只需要会 <code>open/read/write</code> 三板斧就行了。</p>
<p>下一章，我们将把手弄脏，亲自编译和运行 EwokOS。</p>
<h2 id="64-驱动注册流程详解">6.4 驱动注册流程详解</h2>
<p>让我们深入了解驱动是如何注册到系统中的：</p>
<p><strong>步骤 1：驱动初始化</strong></p>
<pre><code class="lang-c">int main(int argc, char** argv) {
    // 初始化设备结构
    vdevice_t dev;
    memset(&amp;dev, 0, sizeof(vdevice_t));
    strcpy(dev.name, &quot;timer&quot;);

    // 设置设备控制回调函数
    dev.dev_cntl = timer_dcntl;

    // 向 VFS 注册设备
    device_run(&amp;dev, &quot;/dev/timer&quot;, FS_TYPE_CHAR, 0666);
    return 0;
}
</code></pre>
<p><strong>步骤 2：VFS 挂载</strong>
<code>device_run()</code> 内部会：</p>
<ol>
<li>通过 IPC 连接到 VFS 守护进程。</li>
<li>发送注册请求，包含设备路径和类型。</li>
<li>VFS 在虚拟文件树中创建设备节点。</li>
<li>进入事件循环，等待 VFS 分发请求。</li>
</ol>
<p><strong>步骤 3：设备控制回调</strong></p>
<pre><code class="lang-c">int timer_dcntl(int from_pid, int cmd, proto_t* in, proto_t* out, void* p) {
    switch(cmd) {
        case DEV_CMD_READ:
            // 读取当前时间
            uint64_t time = get_system_time();
            proto_add_uint64(out, time);
            return 0;
        case DEV_CMD_WRITE:
            // 设置定时器
            uint64_t timeout = proto_read_uint64(in);
            set_timer(timeout);
            return 0;
        default:
            return -1;
    }
}
</code></pre>
<h2 id="65-常见驱动实例">6.5 常见驱动实例</h2>
<h3 id="sd-卡驱动-sdd">SD 卡驱动 (<code>sdd</code>)</h3>
<p>负责读写 SD 卡存储。它实现了块设备接口，支持：</p>
<ul>
<li>按扇区读写（通常是 512 字节）</li>
<li>DMA 传输（Direct Memory Access），提高效率</li>
<li>多分区支持</li>
</ul>
<h3 id="usb-驱动-usbd">USB 驱动 (<code>usbd</code>)</h3>
<p>EwokOS 支持 USB 设备！USB 驱动实现了：</p>
<ul>
<li>USB 主机控制器接口（HCI）</li>
<li>设备枚举和识别</li>
<li>USB 键盘、鼠标支持</li>
<li>USB 存储设备支持</li>
</ul>
<h3 id="framebuffer-驱动-fbd">Framebuffer 驱动 (<code>fbd</code>)</h3>
<p>图形显示的基础，提供：</p>
<ul>
<li>像素缓冲区映射</li>
<li>图形模式切换</li>
<li>双缓冲（避免闪烁）</li>
<li>支持多种分辨率（如 1024x768）</li>
</ul>
<h2 id="66-vfs-挂载机制">6.6 VFS 挂载机制</h2>
<p>VFS 维护了一棵虚拟文件树。挂载点可以是：</p>
<p><strong>根文件系统</strong>：</p>
<pre><code>mount(&quot;/&quot;, &quot;ext2&quot;, &quot;/dev/mmcblk0p1&quot;);  // 挂载 SD 卡第一分区为根
</code></pre><p><strong>设备文件系统</strong>：</p>
<pre><code>/dev/
├── timer    -&gt; timerd
├── tty0     -&gt; uartd
├── fb0      -&gt; fbd
├── mmcblk0  -&gt; sdd
└── ...
</code></pre><p><strong>进程信息文件系统</strong>：</p>
<pre><code>/proc/
├── 1/       -&gt; Core 进程信息
├── 2/       -&gt; VFS 进程信息
└── ...
</code></pre><p><strong>实际挂载过程</strong>：</p>
<ol>
<li>文件系统驱动（如 <code>ext2d</code>）向 VFS 注册。</li>
<li>VFS 调用驱动的 <code>mount()</code> 方法。</li>
<li>驱动读取分区超级块，建立目录索引。</li>
<li>VFS 将挂载点加入全局挂载表。</li>
</ol>
<h2 id="67-本章小结与展望">6.7 本章小结与展望</h2>
<p>我们刚刚探索了微内核的&quot;服务窗口&quot;——驱动与 VFS。让我们回顾关键点：</p>
<ul>
<li><strong>驱动的革命</strong>：从内核态的&quot;御前侍卫&quot;变成用户态的&quot;打工仔&quot;，带来了前所未有的稳定性</li>
<li><strong>VFS 的智慧</strong>：统一接口，&quot;一切皆文件&quot;，让应用程序无需关心底层细节</li>
<li><strong>真实案例</strong>：Windows 蓝屏 85% 由驱动导致，微内核架构从根本上避免了这个问题</li>
<li><strong>挂载机制</strong>：将各种设备和文件系统组织成一棵虚拟文件树</li>
</ul>
<p>我们已经理解了 EwokOS 的核心机制：</p>
<ul>
<li><strong>进程管理</strong>（心脏）：如何调度和切换进程</li>
<li><strong>IPC</strong>（神经系统）：进程如何通信</li>
<li><strong>内存管理</strong>（土地规划）：如何分配和保护内存</li>
<li><strong>驱动与 VFS</strong>（服务窗口）：如何访问硬件和文件</li>
</ul>
<p>理论已经足够了。现在，是时候<strong>把手弄脏</strong>了！</p>
<p><strong>这就是下一章的主题——编译与运行</strong>。我们将：</p>
<ul>
<li>亲手编译 EwokOS 内核和系统</li>
<li>在 QEMU 模拟器上运行它</li>
<li>把它刷到真实的 Raspberry Pi 上</li>
<li>使用 GDB 调试内核</li>
<li>编写你的第一个 EwokOS 应用程序</li>
</ul>
<p>从理论到实践，从阅读代码到编写代码，从虚拟机到真实硬件——让我们完成这最后的冲刺！</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="chapter5_memory.html" class="navigation navigation-prev " aria-label="Previous page: 第五章：包租公 - 内存管理">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="chapter7_hands_on.html" class="navigation navigation-next " aria-label="Next page: 第七章：把手弄脏 - 编译与运行">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"第六章：打工魂 - 驱动与 VFS","level":"1.7","depth":1,"next":{"title":"第七章：把手弄脏 - 编译与运行","level":"1.8","depth":1,"path":"chapter7_hands_on.md","ref":"chapter7_hands_on.md","articles":[]},"previous":{"title":"第五章：包租公 - 内存管理","level":"1.6","depth":1,"path":"chapter5_memory.md","ref":"chapter5_memory.md","articles":[]},"dir":"ltr"},"config":{"plugins":["mermaid"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mermaid":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Misa.Z","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"EwokOS Microkernel Booklet","language":"zh-hans","gitbook":"*","description":"A deep dive into the EwokOS microkernel."},"file":{"path":"chapter6_drivers.md","mtime":"2025-11-24T12:59:19.138Z","type":"markdown"},"gitbook":{"version":"4.0.8","time":"2025-11-24T12:59:28.256Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/honkit-plugin-mermaid/mermaid-load.js"></script>
        
    
        
        <script src="gitbook/honkit-plugin-mermaid/mermaid.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

