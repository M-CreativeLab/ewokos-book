
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <title>第六章：打工魂 - 驱动与 VFS · EwokOS Microkernel Booklet</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="HonKit 4.0.8">
        <meta name="author" content="Misa.Z">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/honkit-plugin-mermaid/mermaid.css">
                
            
                
                <link rel="stylesheet" href="gitbook/@honkit/honkit-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="chapter7_hands_on.html" />
    
    
    <link rel="prev" href="chapter5_memory.html" />
    

    </head>
    <body>
        
<div class="book honkit-cloak">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    前言
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="chapter1_intro.html">
            
                <a href="chapter1_intro.html">
            
                    
                    第一章：操作系统的世界
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="chapter2_arch.html">
            
                <a href="chapter2_arch.html">
            
                    
                    第二章：EwokOS - 小内核，大梦想
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" data-path="chapter3_proc.html">
            
                <a href="chapter3_proc.html">
            
                    
                    第三章：幕后黑手 - 进程与线程
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5" data-path="chapter4_ipc.html">
            
                <a href="chapter4_ipc.html">
            
                    
                    第四章：喂，听得见吗？ - IPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6" data-path="chapter5_memory.html">
            
                <a href="chapter5_memory.html">
            
                    
                    第五章：包租公 - 内存管理
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.7" data-path="chapter6_drivers.html">
            
                <a href="chapter6_drivers.html">
            
                    
                    第六章：打工魂 - 驱动与 VFS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8" data-path="chapter7_hands_on.html">
            
                <a href="chapter7_hands_on.html">
            
                    
                    第七章：把手弄脏 - 编译与运行
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://github.com/honkit/honkit" target="blank" class="gitbook-link">
            本书使用 HonKit 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >第六章：打工魂 - 驱动与 VFS</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="第六章：打工魂---驱动与-vfs">第六章：打工魂 - 驱动与 VFS</h1>
<h2 id="61-驱动：我也是个普通人">6.1 驱动：我也是个普通人</h2>
<p>在宏内核里，驱动是拥有至高无上权力的“御前侍卫”。
在微内核里，驱动只是一个普通的“打工仔”。</p>
<h3 id="驱动就是进程">驱动就是进程</h3>
<p>EwokOS 的驱动程序（比如 <code>timerd</code>, <code>uartd</code>）本质上就是<strong>用户进程</strong>。
它们有自己的 <code>main</code> 函数，有自己的 PID，甚至可以被 <code>kill</code> 掉。</p>
<p>唯一的区别是，它们通过系统调用申请了一些特权：</p>
<ul>
<li><strong>I/O 端口访问权</strong>：允许读写特定的硬件端口。</li>
<li><strong>MMIO 映射权</strong>：允许把硬件的物理内存映射到自己的虚拟空间。</li>
<li><strong>中断处理权</strong>：允许接收硬件发出的中断信号。</li>
</ul>
<h2 id="62-实例分析：timerd-的一天">6.2 实例分析：<code>timerd</code> 的一天</h2>
<p>让我们看看时钟驱动 <code>timerd</code> (<code>system/basic/drivers/timerd/timerd.c</code>) 是怎么工作的。</p>
<ol>
<li><p><strong>上班打卡 (启动)</strong>：</p>
<pre><code class="lang-c">int main(int argc, char** argv) {
    // ... 初始化 ...
    vdevice_t dev;
    strcpy(dev.name, &quot;timer&quot;);
    dev.dev_cntl = timer_dcntl; // 设置“业务受理窗口”

    // 向 VFS 注册：我负责 /dev/timer 这个地盘
    device_run(&amp;dev, &quot;/dev/timer&quot;, FS_TYPE_CHAR, 0666);
    return 0;
}
</code></pre>
</li>
<li><p><strong>等待业务 (循环)</strong>：
<code>device_run</code> 内部是一个无限循环，不断调用 <code>ipc_fetch</code> 等待 VFS 派活。</p>
</li>
<li><p><strong>处理业务 (中断)</strong>：
当硬件产生时钟中断时，内核会通知 <code>timerd</code>。
<code>timerd</code> 醒来，更新系统时间，检查有没有闹钟到期了。</p>
</li>
</ol>
<h2 id="63-vfs：全能前台">6.3 VFS：全能前台</h2>
<p><strong>VFS (Virtual File System)</strong> 是整个系统的“前台接待”。
不管你是要读文件、写串口、还是画图，你都得先找 VFS。</p>
<p>EwokOS 遵循 Unix 的哲学：<strong>一切皆文件</strong>。</p>
<ul>
<li>硬盘文件是文件：<code>/home/test.txt</code></li>
<li>串口是文件：<code>/dev/tty0</code></li>
<li>显卡是文件：<code>/dev/fb0</code></li>
<li>甚至进程信息也是文件：<code>/proc/123</code></li>
</ul>
<h3 id="一次-open-的旅程">一次 <code>open</code> 的旅程</h3>
<p>当你调用 <code>open(&quot;/dev/timer&quot;, ...)</code> 时：</p>
<ol>
<li><strong>用户进程</strong>：呼叫 VFS，“我要打开 <code>/dev/timer</code>”。</li>
<li><strong>VFS</strong>：查通讯录（挂载表），发现 <code>/dev/timer</code> 归 <code>timerd</code> 管。</li>
<li><strong>VFS</strong>：呼叫 <code>timerd</code>，“有人要打开你”。</li>
<li><strong>timerd</strong>：确认没问题，返回“同意”。</li>
<li><strong>VFS</strong>：给用户进程发一张“通行证”（文件描述符 fd），上面写着：“以后找 <code>timerd</code>，直接报这个号”。</li>
</ol>
<h3 id="一次-write-的旅程">一次 <code>write</code> 的旅程</h3>
<p>当你调用 <code>write(fd, &quot;hello&quot;, 5)</code> 时：</p>
<ol>
<li><strong>用户进程</strong>：拿着通行证 (fd) 呼叫 VFS。</li>
<li><strong>VFS</strong>：看一眼通行证，哦，是找 <code>timerd</code> 的。</li>
<li><strong>VFS</strong>：把数据转发给 <code>timerd</code>。</li>
<li><strong>timerd</strong>：收到数据，执行相应的硬件操作。</li>
</ol>
<p>虽然中间隔了个 VFS，看起来有点繁琐，但它统一了接口。用户程序不需要知道对面是硬盘还是串口，只需要会 <code>open/read/write</code> 三板斧就行了。</p>
<p>下一章，我们将把手弄脏，亲自编译和运行 EwokOS。</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="chapter5_memory.html" class="navigation navigation-prev " aria-label="Previous page: 第五章：包租公 - 内存管理">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="chapter7_hands_on.html" class="navigation navigation-next " aria-label="Next page: 第七章：把手弄脏 - 编译与运行">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"第六章：打工魂 - 驱动与 VFS","level":"1.7","depth":1,"next":{"title":"第七章：把手弄脏 - 编译与运行","level":"1.8","depth":1,"path":"chapter7_hands_on.md","ref":"chapter7_hands_on.md","articles":[]},"previous":{"title":"第五章：包租公 - 内存管理","level":"1.6","depth":1,"path":"chapter5_memory.md","ref":"chapter5_memory.md","articles":[]},"dir":"ltr"},"config":{"plugins":["mermaid"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"mermaid":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Misa.Z","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56},"embedFonts":false},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"EwokOS Microkernel Booklet","language":"zh-hans","gitbook":"*","description":"A deep dive into the EwokOS microkernel."},"file":{"path":"chapter6_drivers.md","mtime":"2025-11-24T07:03:29.891Z","type":"markdown"},"gitbook":{"version":"4.0.8","time":"2025-11-24T07:03:38.594Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <noscript>
        <style>
            .honkit-cloak {
                display: block !important;
            }
        </style>
    </noscript>
    <script>
        // Restore sidebar state as critical path for prevent layout shift
        function __init__getSidebarState(defaultValue){
            var baseKey = "";
            var key = baseKey + ":sidebar";
            try {
                var value = localStorage[key];
                if (value === undefined) {
                    return defaultValue;
                }
                var parsed = JSON.parse(value);
                return parsed == null ? defaultValue : parsed;
            } catch (e) {
                return defaultValue;
            }
        }
        function __init__restoreLastSidebarState() {
            var isMobile = window.matchMedia("(max-width: 600px)").matches;
            if (isMobile) {
                // Init last state if not mobile
                return;
            }
            var sidebarState = __init__getSidebarState(true);
            var book = document.querySelector(".book");
            // Show sidebar if it enabled
            if (sidebarState && book) {
                book.classList.add("without-animation", "with-summary");
            }
        }

        try {
            __init__restoreLastSidebarState();
        } finally {
            var book = document.querySelector(".book");
            book.classList.remove("honkit-cloak");
        }
    </script>
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/honkit-plugin-mermaid/mermaid-load.js"></script>
        
    
        
        <script src="gitbook/honkit-plugin-mermaid/mermaid.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

